job "elasticsearch" {
  datacenters = ["dc1"]

  group "elasticsearch" {
    count = 1

    network {
      mode = "host"
      port "http" {
            static = 9200
        }
        port "tcp" {
            static = 9300
        }
    }

    task "elastic_container" {
      driver = "docker"

      env = {
        "ES_JAVA_OPTS"           = "-Xms512m -Xmx512m"
        "ELASTIC_PASSWORD"       = "elasticpassword"
        "discovery.type"         = "single-node"
        "bootstrap.memory_lock"  = "true"
      }

      template {
          data = <<EOH
# network.host: 0.0.0.0
xpack.license.self_generated.type: basic
# xpack.security.enabled: true
# xpack.monitoring.collection.enabled: false 
# http.cors.enabled : true
# http.cors.allow-origin: "*"
# http.cors.allow-methods: OPTIONS, HEAD, GET, POST, PUT, DELETE
# http.cors.allow-credentials: true
# http.cors.allow-headers: X-Requested-With, X-Auth-Token, Content-Type, Content-Length, Authorization, Access-Control-Allow-Headers, Accept

path.repo: ["/snapshots"]
          EOH
   
          destination = "local/elastic/elasticsearch.yml"
        }

      config {
        network_mode = "host"
        image = "docker.elastic.co/elasticsearch/elasticsearch:8.8.0"
        command = "elasticsearch"
        ports = ["http","tcp"]
        volumes = [
          "local/elastic/snapshots:/snapshots",
        ]
      }

      resources {
        cpu    = 6000
        memory = 4000
      }
    }
  }
}
